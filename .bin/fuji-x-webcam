#!/usr/bin/env bash

usage() {
  echo >&2 "Usage: $0 [ c(apture) | p(review) ]"
  exit 1
}

load() {
  lsmod | grep -q ^v4l2loopback ||
    sudo modprobe v4l2loopback \
      card_label="Fuji X-T30" \
      exclusive_caps=1 \
      max_buffers=2
}

capture() {
  gphoto2 \
    --quiet \
    --stdout \
    --capture-movie \
    | gst-launch-1.0 \
      --quiet \
      --no-position \
      fdsrc fd=0 \
      ! decodebin name=dec \
      ! queue \
      ! videoconvert \
      ! v4l2sink device=/dev/video4
}

preview() {
  mpv \
    --no-cache \
    --untimed \
    --no-demuxer-thread \
    --video-sync=audio \
    --vd-lavc-threads=1 \
    --vf=hflip \
    av://v4l2://dev/video4 \
    "$@"
}

action=${1:-capture}
shift

case $action in
  p*)
    preview "$@"
    ;;
  c*)
    load
    capture "$@"
    ;;
  *)
    usage
    ;;
esac
